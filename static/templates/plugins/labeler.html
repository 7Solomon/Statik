<div class="max-w-7xl mx-auto flex flex-col p-4 gap-4">

    <!-- Header Area -->
    <div class="flex justify-between items-center px-2">
        <h2 class="text-2xl font-bold text-slate-800">System Labeler</h2>

        <div class="flex gap-2">
            <!-- Grid Size Input -->
            <div class="flex items-center gap-2 bg-slate-100 px-3 py-1.5 rounded-lg border border-slate-200">
                <span class="text-xs font-semibold text-slate-500 uppercase">Raster:</span>
                <input type="number" id="grid-size-input" value="1.0" step="0.1" min="0.1"
                    class="w-16 bg-white border border-slate-300 rounded px-2 py-0.5 text-sm text-slate-700 focus:outline-none focus:border-blue-500"
                    onchange="updateGridSize(this.value)">
                <span class="text-xs text-slate-400">m</span>
            </div>

            <!-- Action Buttons -->
            <button onclick="clearCanvas()"
                class="px-4 py-2 bg-red-50 text-red-600 hover:bg-red-100 rounded-lg transition-colors text-sm font-medium">
                Clear
            </button>

            <button onclick="runAnalysis()"
                class="px-4 py-2 bg-indigo-600 text-white hover:bg-indigo-700 rounded-lg transition-colors text-sm font-medium shadow-sm">
                Analyze
            </button>

            <button onclick="toggleFileDrawer()"
                class="px-4 py-2 bg-white text-slate-600 border border-slate-200 hover:bg-slate-50 hover:text-blue-600 rounded-lg transition-colors text-sm font-medium shadow-sm flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M5 19a2 2 0 01-2-2V7a2 2 0 012-2h4l2 2h4a2 2 0 012 2v1M5 19h14a2 2 0 002-2v-5a2 2 0 00-2-2H9a2 2 0 00-2 2v5a2 2 0 01-2 2z" />
                </svg>
                Files
            </button>

            </button>
        </div>
    </div>

    <!-- PANEL 1: EDITOR (Open by default) -->
    <div id="editor-panel" class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
        <!-- Panel Header -->
        <div class="flex items-center justify-between px-4 py-3 border-b border-slate-200 bg-slate-50 cursor-pointer hover:bg-slate-100 transition-colors"
            onclick="togglePanel('editor')">
            <h3 class="text-sm font-semibold text-slate-700 uppercase tracking-wide flex items-center gap-2">
                <span class="w-2 h-2 rounded-full bg-blue-500"></span> Editor
            </h3>
            <!-- Chevron Icon (Rotated 180deg because it starts OPEN) -->
            <svg id="arrow-editor" class="w-5 h-5 text-slate-400 transform transition-transform duration-200 rotate-180"
                fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
        </div>

        <!-- Panel Body (Visible by default) -->
        <div id="body-editor" class="p-4 transition-all duration-300 ease-in-out">
            <div class="h-[600px] flex gap-6">

                <!-- Canvas Container -->
                <div class="flex-[4] bg-white rounded-lg border border-slate-200 relative overflow-hidden cursor-crosshair shadow-inner"
                    id="canvas-container">
                    <canvas id="structure-canvas" class="absolute top-0 left-0 w-full h-full block"></canvas>

                    <!-- Coordinates Overlay -->
                    <div
                        class="absolute bottom-4 left-4 bg-white/90 backdrop-blur px-3 py-1 rounded-md shadow-sm text-xs text-slate-500 font-mono border border-slate-200 pointer-events-none">
                        x: <span id="coord-x">0.00</span>, y: <span id="coord-y">0.00</span>
                    </div>
                </div>

                <!-- Tools Sidebar -->
                <div class="w-72 flex flex-col gap-4 overflow-y-auto pr-1">

                    <!-- labeler.html -->

                    <!-- SECTION 1: MEMBERS (formerly Connections) -->
                    <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                        <h3 class="font-semibold mb-3 text-slate-800 text-sm uppercase tracking-wide">Stäbe (Members)
                        </h3>
                        <div class="grid grid-cols-2 gap-2">

                            <!-- Normal Beam -->
                            <button onclick="setTool('connection', 'normal')" id="btn-connection-normal"
                                class="tool-btn w-full flex items-center justify-center gap-2 border-2 border-slate-200 p-2 rounded hover:border-blue-400 transition-all">
                                <div class="w-8 h-1 bg-slate-600"></div>
                                <span class="text-xs font-medium">Stab</span>
                            </button>

                            <!-- Truss (Fachwerk) -->
                            <button onclick="setTool('connection', 'truss')" id="btn-connection-truss"
                                class="tool-btn w-full flex items-center justify-center gap-2 border-2 border-slate-200 p-2 rounded hover:border-blue-400 transition-all">
                                <div class="w-8 h-0.5 bg-slate-800"></div>
                                <span class="text-xs font-medium">Fachwerk</span>
                            </button>

                            <!-- Fiber (Biegung mit Faser) -->
                            <button onclick="setTool('connection', 'fiber')" id="btn-connection-fiber"
                                class="tool-btn w-full flex items-center justify-center gap-2 border-2 border-slate-200 p-2 rounded hover:border-blue-400 transition-all">
                                <div class="flex flex-col gap-0.5 items-center">
                                    <div class="w-8 h-1.5 bg-slate-800"></div>
                                    <div class="w-8 h-0 border-t border-dashed border-slate-400"></div>
                                </div>
                                <span class="text-xs font-medium">Biegebalken</span>
                            </button>

                            <!-- Hidden (Versteckt) -->
                            <button onclick="setTool('connection', 'hidden')" id="btn-connection-hidden"
                                class="tool-btn w-full flex items-center justify-center gap-2 border-2 border-slate-200 p-2 rounded hover:border-blue-400 transition-all">
                                <div class="w-8 h-0 border-t-2 border-dashed border-slate-400"></div>
                                <span class="text-xs font-medium">Versteckt</span>
                            </button>

                        </div>

                        <!-- Delete Tool -->
                        <div class="mt-2">
                            <button onclick="setTool('delete', 'delete')" id="btn-delete-delete"
                                class="tool-btn w-full flex items-center justify-center gap-2 border-2 border-slate-200 p-2 rounded hover:bg-red-50 hover:border-red-400 transition-all text-red-600">
                                <span class="text-sm font-medium">Löschen</span>
                            </button>
                        </div>
                    </div>


                    <!-- SECTION 2: SUPPORTS (Lager) -->
                    <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                        <h3 class="font-semibold mb-3 text-slate-800 text-sm uppercase tracking-wide">Lager
                            (Supports)
                        </h3>
                        <div class="grid grid-cols-3 gap-2">
                            <button onclick="setTool('support', 'festlager')" id="btn-support-festlager"
                                class="tool-btn border-2 border-slate-200 p-2 rounded hover:border-blue-400">
                                <img src="/symbols/get/festlager"
                                    class="w-full h-8 object-contain mb-1 pointer-events-none">
                                <span class="text-[10px] block text-center text-slate-600">Fest</span>
                            </button>
                            <button onclick="setTool('support', 'loslager')" id="btn-support-loslager"
                                class="tool-btn border-2 border-slate-200 p-2 rounded hover:border-blue-400">
                                <img src="/symbols/get/loslager"
                                    class="w-full h-8 object-contain mb-1 pointer-events-none">
                                <span class="text-[10px] block text-center text-slate-600">Los</span>
                            </button>
                            <button onclick="setTool('support', 'einspannung')" id="btn-support-einspannung"
                                class="tool-btn border-2 border-slate-200 p-2 rounded hover:border-blue-400">
                                <img src="/symbols/get/einspannung"
                                    class="w-full h-8 object-contain mb-1 pointer-events-none">
                                <span class="text-[10px] block text-center text-slate-600">Einsp.</span>
                            </button>
                            <button onclick="setTool('support', 'gleitlager')" id="btn-support-gleitlager"
                                class="tool-btn border-2 border-slate-200 p-2 rounded hover:border-blue-400">
                                <img src="/symbols/get/gleitlager"
                                    class="w-full h-8 object-contain mb-1 pointer-events-none">
                                <span class="text-[10px] block text-center text-slate-600">Gleit</span>
                            </button>
                        </div>
                    </div>

                    <!-- SECTION 3: HINGES (Gelenke) -->
                    <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                        <h3 class="font-semibold mb-3 text-slate-800 text-sm uppercase tracking-wide">Gelenke
                            (Hinges)
                        </h3>
                        <div class="grid grid-cols-3 gap-2">
                            <button onclick="setTool('hinge', 'vollgelenk')" id="btn-hinge-vollgelenk"
                                class="tool-btn border-2 border-slate-200 p-2 rounded hover:border-green-400">
                                <img src="/symbols/get/vollgelenk"
                                    class="w-full h-8 object-contain mb-1 pointer-events-none">
                                <span class="text-[10px] block text-center text-slate-600">Voll</span>
                            </button>
                        </div>
                    </div>
                    <!-- Add this Block to your Toolbar in labeler.html -->

                    <!-- LOAD TOOLS -->
                    <div class="grid grid-cols-2 gap-2">
                        <!-- Point Load -->
                        <button id="btn-load-force" onclick="setTool('load', 'force')"
                            class="tool-btn flex flex-col items-center justify-center p-2 rounded bg-slate-50 border border-slate-200 hover:bg-white hover:border-blue-400 hover:shadow-sm transition-all text-slate-600">
                            <span class="text-xl font-bold">↓</span>
                            <span class="text-[10px] mt-1">Einzelast</span>
                        </button>

                        <!-- Distributed Load -->
                        <button id="btn-load-distributed" onclick="setTool('load', 'distributed')"
                            class="tool-btn flex flex-col items-center justify-center p-2 rounded bg-slate-50 border border-slate-200 hover:bg-white hover:border-blue-400 hover:shadow-sm transition-all text-slate-600">
                            <span class="text-xl font-bold">↓↓↓</span>
                            <span class="text-[10px] mt-1">Streckenlast</span>
                        </button>

                        <!-- Moment -->
                        <button id="btn-load-moment" onclick="setTool('load', 'moment')"
                            class="tool-btn flex flex-col items-center justify-center p-2 rounded bg-slate-50 border border-slate-200 hover:bg-white hover:border-blue-400 hover:shadow-sm transition-all text-slate-600">
                            <span class="text-xl font-bold">↻</span>
                            <span class="text-[10px] mt-1">Moment</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- PANEL 2: SYSTEM VIEW -->
    <div id="system-panel" class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
        <!-- Panel Header -->
        <div class="flex items-center justify-between px-4 py-3 border-b border-slate-200 bg-slate-50 cursor-pointer hover:bg-slate-100 transition-colors"
            onclick="togglePanel('system')">
            <h3 class="text-sm font-semibold text-slate-700 uppercase tracking-wide flex items-center gap-2">
                <span class="w-2 h-2 rounded-full bg-emerald-500"></span> Analysis Result
            </h3>
            <svg id="arrow-system" class="w-5 h-5 text-slate-400 transform transition-transform duration-200"
                fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
        </div>

        <!-- Panel Body -->
        <div id="body-system" class="p-4 transition-all duration-300 ease-in-out" style="display: none;">
            <div class="h-96 w-full bg-slate-50 rounded-lg border border-slate-200 relative overflow-hidden shadow-inner"
                id="system-view-container">

                <canvas id="system-view-canvas" class="absolute inset-0 w-full h-full block"></canvas>

                <!-- NEW: Analysis Controls Overlay -->
                <div id="view-controls"
                    class="absolute bottom-4 left-4 bg-white/95 backdrop-blur px-3 py-2 rounded-lg shadow-md border border-slate-200 flex flex-col gap-2 z-10 hidden">

                    <!-- Mode Selector -->
                    <div class="flex items-center justify-between gap-4">
                        <label class="text-xs font-bold text-slate-500 uppercase">Mode</label>
                        <select id="mode-selector"
                            class="text-sm bg-slate-50 border border-slate-300 rounded px-2 py-0.5 outline-none focus:border-blue-500 min-w-[100px]">
                            <!-- Options injected by JS -->
                        </select>
                    </div>

                    <!-- Amplitude Slider -->
                    <div class="flex items-center justify-between gap-4">
                        <label class="text-xs font-bold text-slate-500 uppercase">Amp</label>
                        <input type="range" id="amp-slider" min="0" max="200" value="50"
                            class="w-24 h-1 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- FILE MANAGER DRAWER -->

    <!-- Backdrop -->
    <div id="file-drawer-backdrop" class="fixed inset-0 bg-slate-900/20 backdrop-blur-sm z-40 hidden"
        onclick="toggleFileDrawer()"></div>

    <!-- Drawer -->
    <div id="file-drawer"
        class="fixed top-0 right-0 h-full w-80 bg-white shadow-2xl z-50 transform transition-transform duration-300 translate-x-full flex flex-col border-l border-slate-200">

        <!-- Drawer Header -->
        <div class="p-4 border-b border-slate-200 bg-slate-50 flex justify-between items-center">
            <h3 class="font-bold text-slate-700 flex items-center gap-2">
                <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M5 19a2 2 0 01-2-2V7a2 2 0 012-2h4l2 2h4a2 2 0 012 2v1M5 19h14a2 2 0 002-2v-5a2 2 0 00-2-2H9a2 2 0 00-2 2v5a2 2 0 01-2 2z" />
                </svg>
                File Manager
            </h3>
            <button onclick="toggleFileDrawer()" class="text-slate-400 hover:text-slate-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>

        <!-- Section: Save Current -->
        <div class="p-4 border-b border-slate-200 bg-white">
            <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Save Current System</label>
            <div class="flex gap-2">
                <input type="text" id="save-name-input" placeholder="e.g., Einfeld Träger"
                    class="flex-1 bg-white border border-slate-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all">
                <button onclick="handleSave()"
                    class="bg-blue-600 text-white px-3 py-2 rounded-lg hover:bg-blue-700 transition-colors font-medium text-sm">
                    Save
                </button>
            </div>
        </div>

        <!-- Section: File List -->
        <div class="flex-1 overflow-y-auto p-4 bg-slate-50">
            <label class="block text-xs font-bold text-slate-500 uppercase mb-3">Saved Systems</label>

            <!-- Loader -->
            <div id="file-list-loader" class="hidden text-center py-4 text-slate-400 text-sm">
                Loading...
            </div>

            <!-- List Container -->
            <div id="file-list-container" class="space-y-2">
                <!-- Items will be injected via JS -->
            </div>
        </div>
    </div>

</div>